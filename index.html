<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartMarket</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: var(--tg-theme-bg-color, #f2f2f7);
  --card: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #000000);
  --hint: var(--tg-theme-hint-color, #8e8e93);
  --accent: var(--tg-theme-button-color, #007aff);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Roboto;
  background: var(--bg);
  color: var(--text);
}

.page {
  display: none;
  padding: 16px;
  padding-bottom: 100px;
}
.page.active { display: block; }

input, textarea {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  margin-bottom: 12px;
  font-size: 16px;
  background: var(--card);
  color: var(--text);
}

textarea { resize: none; }

.card {
  background: var(--card);
  border-radius: 18px;
  padding: 14px;
  margin-bottom: 14px;
}

.card img {
  width: 100%;
  border-radius: 14px;
  margin-bottom: 10px;
}

.price { color: var(--hint); margin-top: 6px; }

.btn {
  width: 100%;
  padding: 14px;
  border-radius: 16px;
  border: none;
  font-size: 16px;
  background: var(--accent);
  color: white;
}

.small-btn {
  margin-top: 10px;
  background: none;
  color: var(--accent);
  border: 1px solid var(--accent);
}

.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  display: flex;
  border-top: 1px solid #ddd;
}

.tabbar button {
  flex: 1;
  padding: 14px;
  background: none;
  border: none;
  font-size: 15px;
  color: var(--hint);
}

.tabbar button.active {
  color: var(--accent);
  font-weight: 600;
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
}
.modal.active { display: flex; }

.modal-content {
  margin: auto;
  background: var(--bg);
  padding: 20px;
  width: 90%;
  border-radius: 20px;
}

/* LOADING */
.loading {
  text-align: center;
  padding: 20px;
  display: none;
}

.loading.active {
  display: block;
}

/* ERROR */
.error-message {
  background: #ffebee;
  padding: 12px;
  border-radius: 12px;
  margin: 10px 0;
  color: #c62828;
  display: none;
  font-size: 14px;
}

/* FILE INPUT STYLING */
.file-input-container {
  position: relative;
  margin-bottom: 12px;
}

.file-input-container input[type="file"] {
  opacity: 0;
  position: absolute;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.file-input-label {
  display: block;
  padding: 14px;
  background: var(--card);
  border-radius: 14px;
  text-align: center;
  color: var(--hint);
  border: 1px dashed var(--hint);
}

.file-input-label.has-file {
  color: var(--accent);
  border-color: var(--accent);
}

/* PHOTO PREVIEW */
.photo-preview {
  display: none;
  margin-bottom: 12px;
}

.photo-preview.active {
  display: block;
}

.photo-preview img {
  width: 100%;
  border-radius: 14px;
}
</style>
</head>

<body>

<!-- ALL ADS -->
<div id="allAds" class="page active">
  <h2>–û–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
  <input id="search" placeholder="–ü–æ–∏—Å–∫">
  <button class="btn small-btn" onclick="openModal()">+ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å</button>
  <div id="allAdsList"></div>
</div>

<!-- MY ADS -->
<div id="myAds" class="page">
  <h2>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
  <div id="myAdsList"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
  <input id="name" placeholder="–§–ò–û">
  <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
  <button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- MODAL ADD -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
    
    <input id="title" placeholder="–ú–æ–¥–µ–ª—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
    <input id="price" placeholder="–¶–µ–Ω–∞ ‚ÇΩ">
    <input id="district" placeholder="–†–∞–π–æ–Ω">
    <textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    
    <!-- Photo Preview -->
    <div id="photoPreview" class="photo-preview">
      <img id="previewImage" src="" alt="Preview">
    </div>
    
    <!-- File Input with Custom Styling -->
    <div class="file-input-container">
      <input type="file" id="photo" accept="image/*" onchange="handlePhotoSelect(event)">
      <label for="photo" id="fileLabel" class="file-input-label">
        üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
      </label>
    </div>
    
    <!-- Loading and Error Messages -->
    <div id="loading" class="loading">
      –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...
    </div>
    
    <div id="error" class="error-message"></div>
    
    <button class="btn" onclick="addAd()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <button class="active" id="b1">–û–±—ä—è–≤–ª–µ–Ω–∏—è</button>
  <button id="b2">–ú–æ–∏</button>
  <button id="b3">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready(); tg.expand();

const USER = tg.initDataUnsafe.user;
const USER_ID = USER.id;
const USERNAME = USER.username || "";

// –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbw-LtHVZYiQRqEKIK5-aFjBrryR9T4Ne2L8AQSO-5lMt9SApU6ewPKNpdvb9nhismkzBg/exec";

/* NAVIGATION */
b1.onclick = () => {
  show(allAds, b1);
  loadAllAds();
};

b2.onclick = () => {
  show(myAds, b2);
  loadMyAds();
};

b3.onclick = () => {
  show(profile, b3);
  loadProfile();
};

function show(page, button) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tabbar button').forEach(x => x.classList.remove('active'));
  page.classList.add('active');
  button.classList.add('active');
}

/* MODAL FUNCTIONS */
function openModal() {
  modal.classList.add('active');
  clearForm();
}

function closeModal() {
  modal.classList.remove('active');
  clearForm();
}

function clearForm() {
  title.value = "";
  price.value = "";
  district.value = "";
  desc.value = "";
  photo.value = "";
  fileLabel.textContent = "üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ";
  fileLabel.classList.remove("has-file");
  photoPreview.classList.remove("active");
  hideError();
}

modal.onclick = function(e) {
  if (e.target === modal) {
    closeModal();
  }
};

/* PHOTO HANDLING */
function handlePhotoSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) { // 5MB limit
    showError("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB");
    photo.value = "";
    return;
  }
  
  // Update label
  fileLabel.textContent = `üì∑ ${file.name}`;
  fileLabel.classList.add("has-file");
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    previewImage.src = e.target.result;
    photoPreview.classList.add("active");
  };
  reader.readAsDataURL(file);
}

/* FILE TO BASE64 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
  });
}

/* ERROR HANDLING */
function showError(message) {
  error.textContent = message;
  error.style.display = "block";
}

function hideError() {
  error.style.display = "none";
}

/* ADD AD FUNCTION */
async function addAd() {
  const file = photo.files[0];
  
  // Validation
  if (!title.value.trim()) {
    showError("–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
    return;
  }
  
  if (!price.value.trim()) {
    showError("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");
    return;
  }
  
  if (!file) {
    showError("–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
    return;
  }
  
  // Show loading
  const btn = document.querySelector('#modal .btn');
  const originalText = btn.textContent;
  btn.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º...";
  btn.disabled = true;
  loading.style.display = "block";
  hideError();
  
  try {
    // Convert to Base64
    const base64 = await fileToBase64(file);
    
    // Send to server
    const response = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "addAd",
        userId: USER_ID,
        username: USERNAME,
        title: title.value.trim(),
        price: price.value.trim(),
        district: district.value.trim(),
        desc: desc.value.trim(),
        imageBase64: base64,
        imageName: file.name
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Success
      tg.showAlert("‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
      closeModal();
      loadAllAds();
      loadMyAds();
    } else {
      throw new Error(result.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
    }
  } catch (error) {
    console.error("Error adding ad:", error);
    showError("–û—à–∏–±–∫–∞: " + error.message);
  } finally {
    // Restore button
    btn.textContent = originalText;
    btn.disabled = false;
    loading.style.display = "none";
  }
}

/* LOAD ALL ADS */
function loadAllAds() {
  fetch(https://script.google.com/macros/s/AKfycbzbrLHlGEyzXjq7I2v44c9QMUHuQAVeaXI4TyM9FdSW7H4pCGE1jZ3vBhj7JLxpXkhGuA/exec + "?action=getAds")
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) {
        console.error("Invalid data format:", data);
        return;
      }
      
      const searchTerm = search.value.toLowerCase();
      allAdsList.innerHTML = "";
      
      data
        .filter(ad => 
          ad.title && 
          ad.title.toLowerCase().includes(searchTerm)
        )
        .forEach(ad => {
          const card = document.createElement('div');
          card.className = 'card';
          
          let imageHtml = '';
          if (ad.imageUrl) {
            imageHtml = `<img src="${ad.imageUrl}" alt="${ad.title}" onerror="this.style.display='none'">`;
          }
          
          card.innerHTML = `
            ${imageHtml}
            <strong>${ad.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
            <div>${ad.desc || ''}</div>
            <div class="price">${ad.price || '0'} ‚ÇΩ ¬∑ ${ad.district || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
            <button class="btn small-btn" 
              onclick="tg.openTelegramLink('https://t.me/${ad.username || 'username'}')">
              –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
            </button>
          `;
          
          allAdsList.appendChild(card);
        });
    })
    .catch(err => {
      console.error("Error loading ads:", err);
      allAdsList.innerHTML = '<div style="text-align:center;color:var(--hint);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
    });
}

/* LOAD MY ADS */
function loadMyAds() {
  fetch(API_URL + "?action=getAds")
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      
      myAdsList.innerHTML = "";
      
      const myAds = data.filter(ad => ad.userId == USER_ID);
      
      if (myAds.length === 0) {
        myAdsList.innerHTML = '<div style="text-align:center;color:var(--hint);">–£ –≤–∞—Å –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>';
        return;
      }
      
      myAds.forEach(ad => {
        const card = document.createElement('div');
        card.className = 'card';
        
        let imageHtml = '';
        if (ad.imageUrl) {
          imageHtml = `<img src="${ad.imageUrl}" alt="${ad.title}" onerror="this.style.display='none'">`;
        }
        
        card.innerHTML = `
          ${imageHtml}
          <strong>${ad.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
          <div>${ad.desc || ''}</div>
          <div class="price">${ad.price || '0'} ‚ÇΩ ¬∑ ${ad.district || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
          <button class="btn small-btn" onclick="tg.showAlert('–≠—Ç–æ –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ')">
            –í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
          </button>
        `;
        
        myAdsList.appendChild(card);
      });
    })
    .catch(err => {
      console.error("Error loading my ads:", err);
    });
}

/* PROFILE FUNCTIONS */
function loadProfile() {
  // Try to load from localStorage
  const savedName = localStorage.getItem('smartmarket_name');
  const savedPhone = localStorage.getItem('smartmarket_phone');
  
  if (savedName) name.value = savedName;
  if (savedPhone) phone.value = savedPhone;
}

function saveProfile() {
  const userName = name.value.trim();
  const userPhone = phone.value.trim();
  
  if (!userName) {
    tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è");
    return;
  }
  
  localStorage.setItem('smartmarket_name', userName);
  localStorage.setItem('smartmarket_phone', userPhone);
  
  tg.showAlert("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
}

/* SEARCH FUNCTIONALITY */
search.addEventListener('input', loadAllAds);

/* AUTO REFRESH */
setInterval(loadAllAds, 10000); // Refresh every 10 seconds

/* INITIAL LOAD */
loadAllAds();
loadProfile();
</script>
</body>
</html>