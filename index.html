<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartMarket</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: var(--tg-theme-bg-color, #f2f2f7);
  --card: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #000000);
  --hint: var(--tg-theme-hint-color, #8e8e93);
  --accent: var(--tg-theme-button-color, #007aff);
  --accentText: var(--tg-theme-button-text-color, #ffffff);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: var(--bg);
  color: var(--text);
}

.page {
  display: none;
  padding: 16px;
  padding-bottom: 90px;
}

.page.active {
  display: block;
}

h2 {
  margin-top: 0;
}

input {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  margin-bottom: 12px;
  font-size: 16px;
  background: var(--card);
  color: var(--text);
}

.card {
  background: var(--card);
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 12px;
}

.price {
  color: var(--hint);
  margin-top: 6px;
}

.btn {
  background: var(--accent);
  color: var(--accentText);
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-size: 14px;
}

.btn-outline {
  background: var(--card);
  color: var(--accent);
  border: 1px solid var(--accent);
}

.delete {
  color: red;
  float: right;
  cursor: pointer;
}

/* bottom bar */
.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  display: flex;
  border-top: 1px solid #ddd;
}

.tabbar button {
  flex: 1;
  padding: 14px;
  background: none;
  border: none;
  font-size: 15px;
  color: var(--hint);
}

.tabbar button.active {
  color: var(--accent);
  font-weight: 600;
}
</style>
</head>

<body>

<!-- PROFILE -->
<div id="profile" class="page">
  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
  <input id="name" placeholder="–§–ò–û">
  <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
  <input id="username" disabled>
  <button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- ALL ADS -->
<div id="allAds" class="page active">
  <h2>–û–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
  <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª–∏ –∏–ª–∏ —Ä–∞–π–æ–Ω—É">
  <div id="allAdsList"></div>
</div>

<!-- MY ADS -->
<div id="myAds" class="page">
  <h2>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
  <div id="myAdsList"></div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <button id="btnAll" class="active">–û–±—ä—è–≤–ª–µ–Ω–∏—è</button>
  <button id="btnMy">–ú–æ–∏</button>
  <button id="btnProfile">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const USER = tg.initDataUnsafe.user;
const USER_ID = USER.id;
const USERNAME = USER.username || "";

// üî¥ –í–°–¢–ê–í–¨ –°–Æ–î–ê URL
const API_URL = "https://script.google.com/macros/s/AKfycbwKJgT9fCS4i3P8dSD5kZZqtXVC25v5GFIT6a4BJRGMu1BE6Oi8XEPnRf8qk_mqfzylZQ/exec";

/* --- TABS --- */
btnAll.onclick = () => switchPage("allAds", btnAll);
btnMy.onclick = () => {
  switchPage("myAds", btnMy);
  loadMyAds();
};
btnProfile.onclick = () => switchPage("profile", btnProfile);

function switchPage(pageId, btn) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".tabbar button").forEach(b => b.classList.remove("active"));
  document.getElementById(pageId).classList.add("active");
  btn.classList.add("active");
}

/* --- PROFILE --- */
fetch(`${API_URL}?action=getUser&userId=${USER_ID}&username=${USERNAME}`)
  .then(r => r.json())
  .then(d => {
    name.value = d.name || "";
    phone.value = d.phone || "";
    username.value = "@" + (d.username || "");
  });

function saveProfile() {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "saveUser",
      userId: USER_ID,
      name: name.value,
      phone: phone.value,
      username: USERNAME
    })
  }).then(() => tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"));
}

/* --- LOAD ALL ADS --- */
function loadAllAds() {
  fetch(`${API_URL}?action=getAds`)
    .then(r => r.json())
    .then(data => renderAllAds(data));
}

function renderAllAds(data) {
  const q = search.value.toLowerCase();
  allAdsList.innerHTML = "";

  data
    .filter(ad =>
      ad.title.toLowerCase().includes(q) ||
      ad.district.toLowerCase().includes(q)
    )
    .forEach(ad => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <strong>${ad.title}</strong>
        <div class="price">${ad.price} ‚ÇΩ ¬∑ ${ad.district}</div>
      `;
      allAdsList.appendChild(div);
    });
}

search.oninput = loadAllAds;

/* --- MY ADS --- */
function loadMyAds() {
  fetch(`${API_URL}?action=getAds`)
    .then(r => r.json())
    .then(data => {
      myAdsList.innerHTML = "";
      data.filter(ad => ad.userId == USER_ID).forEach(ad => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>${ad.title}</strong>
          <span class="delete" onclick="deleteAd(${ad.id})">–£–¥–∞–ª–∏—Ç—å</span>
          <div class="price">${ad.price} ‚ÇΩ ¬∑ ${ad.district}</div>
        `;
        myAdsList.appendChild(div);
      });
    });
}

function deleteAd(id) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "deleteAd",
      id,
      userId: USER_ID
    })
  }).then(loadMyAds);
}

loadAllAds();
setInterval(loadAllAds, 7000);
</script>

</body>
</html>