<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>SmartMarket</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: var(--tg-theme-bg-color, #f4f4f5);
  --text: var(--tg-theme-text-color, #000);
  --hint: var(--tg-theme-hint-color, #666);
  --button: var(--tg-theme-button-color, #2ea6ff);
  --button-text: var(--tg-theme-button-text-color, #fff);
  --card: var(--tg-theme-secondary-bg-color, #fff);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 16px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: var(--bg);
  color: var(--text);
}

h2 {
  margin-top: 0;
}

input, button {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 12px;
  font-size: 16px;
}

input {
  border: 1px solid #ccc;
  background: var(--card);
  color: var(--text);
}

button {
  border: none;
  background: var(--button);
  color: var(--button-text);
  font-weight: 600;
}

.card {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.price {
  font-weight: 600;
}

.delete {
  color: red;
  font-size: 20px;
  cursor: pointer;
}
</style>
</head>

<body>

<h2>üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã –≤ –ú–æ—Å–∫–≤–µ</h2>

<form id="adForm">
  <input id="title" placeholder="–ú–æ–¥–µ–ª—å —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞" required />
  <input id="price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" required />
  <input id="district" placeholder="–†–∞–π–æ–Ω" required />
  <button type="submit">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å</button>
</form>

<div id="ads"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const USER_ID = tg.initDataUnsafe?.user?.id || "browser";

// üî¥ –í–°–¢–ê–í–¨ –°–Æ–î–ê URL
const API_URL = "https://script.google.com/macros/s/AKfycbxVpCmVYLj_V0LGdI8t6wJQ15kxM42H8MkvwWRCTocrS9jXUhOQ3Nvn_6Ayi7xwjEeVuw/exec";

const adsEl = document.getElementById("ads");
const form = document.getElementById("adForm");

function loadAds() {
  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      adsEl.innerHTML = "";
      data.forEach(ad => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div>
            <div>${ad.title}</div>
            <div class="price">${ad.price} ‚ÇΩ ¬∑ ${ad.district}</div>
          </div>
        `;

        if (ad.userId == USER_ID) {
          const del = document.createElement("span");
          del.textContent = "‚ùå";
          del.className = "delete";
          del.onclick = () => deleteAd(ad.id);
          div.appendChild(del);
        }

        adsEl.appendChild(div);
      });
    });
}

form.onsubmit = e => {
  e.preventDefault();
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      title: title.value,
      price: price.value,
      district: district.value,
      userId: USER_ID
    })
  }).then(() => {
    form.reset();
    loadAds();
  });
};

function deleteAd(id) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "delete",
      id,
      userId: USER_ID
    })
  }).then(loadAds);
}

loadAds();
setInterval(loadAds, 7000);
</script>

</body>
</html>