<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartMarket</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: var(--tg-theme-bg-color, #f2f2f7);
  --card: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #000000);
  --hint: var(--tg-theme-hint-color, #8e8e93);
  --accent: var(--tg-theme-button-color, #007aff);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Roboto;
  background: var(--bg);
  color: var(--text);
}

.page {
  display: none;
  padding: 16px;
  padding-bottom: 100px;
}
.page.active { display: block; }

input, textarea {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  margin-bottom: 12px;
  font-size: 16px;
  background: var(--card);
  color: var(--text);
}

textarea { resize: none; }

.card {
  background: var(--card);
  border-radius: 18px;
  padding: 14px;
  margin-bottom: 14px;
}

.card img {
  width: 100%;
  border-radius: 14px;
  margin-bottom: 10px;
}

.price { color: var(--hint); margin-top: 6px; }

.btn {
  width: 100%;
  padding: 14px;
  border-radius: 16px;
  border: none;
  font-size: 16px;
  background: var(--accent);
  color: white;
}

.small-btn {
  margin-top: 10px;
  background: none;
  color: var(--accent);
  border: 1px solid var(--accent);
}

.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  display: flex;
  border-top: 1px solid #ddd;
}

.tabbar button {
  flex: 1;
  padding: 14px;
  background: none;
  border: none;
  font-size: 15px;
  color: var(--hint);
}

.tabbar button.active {
  color: var(--accent);
  font-weight: 600;
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
}
.modal.active { display: flex; }

.modal-content {
  margin: auto;
  background: var(--bg);
  padding: 20px;
  width: 90%;
  border-radius: 20px;
}
</style>
</head>

<body>

<!-- ALL ADS -->
<div id="allAds" class="page active">
  <h2>Объявления</h2>
  <input id="search" placeholder="Поиск">
  <button class="btn small-btn" onclick="openModal()">+ Разместить</button>
  <div id="allAdsList"></div>
</div>

<!-- MY ADS -->
<div id="myAds" class="page">
  <h2>Мои объявления</h2>
  <div id="myAdsList"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
  <h2>Профиль</h2>
  <input id="name" placeholder="ФИО">
  <input id="phone" placeholder="Телефон">
  <button class="btn" onclick="saveProfile()">Сохранить</button>
</div>

<!-- MODAL ADD -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Новое объявление</h3>
    <input id="title" placeholder="Модель телефона">
    <input id="price" placeholder="Цена ₽">
    <input id="district" placeholder="Район">
    <textarea id="desc" placeholder="Описание"></textarea>
    <input type="file" id="photo">
    <button class="btn" onclick="addAd()">Опубликовать</button>
  </div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <button class="active" id="b1">Объявления</button>
  <button id="b2">Мои</button>
  <button id="b3">Профиль</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready(); tg.expand();

const USER = tg.initDataUnsafe.user;
const USER_ID = USER.id;
const USERNAME = USER.username || "";

const API_URL = "https://script.google.com/macros/s/AKfycbwKJgT9fCS4i3P8dSD5kZZqtXVC25v5GFIT6a4BJRGMu1BE6Oi8XEPnRf8qk_mqfzylZQ/exec";

/* NAV */
b1.onclick = ()=>show(allAds,b1);
b2.onclick = ()=>{show(myAds,b2);loadMyAds();}
b3.onclick = ()=>show(profile,b3);

function show(p,b){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tabbar button').forEach(x=>x.classList.remove('active'));
  p.classList.add('active'); b.classList.add('active');
}

/* MODAL */
function openModal(){ modal.classList.add('active'); }
modal.onclick = e => { if(e.target===modal) modal.classList.remove('active'); }

/* ADD AD */
function addAd(){
  const fd = new FormData();
  fd.append("action","addAd");
  fd.append("userId",USER_ID);
  fd.append("username",USERNAME);
  fd.append("title",title.value);
  fd.append("price",price.value);
  fd.append("district",district.value);
  fd.append("desc",desc.value);
  fd.append("photo",photo.files[0]);

  fetch(API_URL,{method:"POST",body:fd})
    .then(()=>{modal.classList.remove('active');loadAllAds();});
}

/* LOAD ADS */
function loadAllAds(){
  fetch(API_URL+"?action=getAds")
    .then(r=>r.json())
    .then(data=>{
      allAdsList.innerHTML="";
      data.filter(a=>a.title.toLowerCase().includes(search.value.toLowerCase()))
      .forEach(ad=>{
        allAdsList.innerHTML+=`
          <div class="card">
            ${ad.imageUrl?`<img src="${ad.imageUrl}">`:``}
            <strong>${ad.title}</strong>
            <div>${ad.desc||""}</div>
            <div class="price">${ad.price} ₽ · ${ad.district}</div>
            <button class="btn small-btn"
              onclick="tg.openTelegramLink('https://t.me/${ad.username}')">
              Написать продавцу
            </button>
          </div>`;
      });
    });
}

function loadMyAds(){ loadAllAds(); }

search.oninput = loadAllAds;
loadAllAds();
setInterval(loadAllAds,7000);
</script>
</body>
</html>