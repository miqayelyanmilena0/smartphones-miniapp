<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SmartMarket</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: var(--tg-theme-bg-color, #f2f2f7);
  --card: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #000000);
  --hint: var(--tg-theme-hint-color, #8e8e93);
  --accent: var(--tg-theme-button-color, #007aff);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: var(--bg);
  color: var(--text);
}

.page {
  display: none;
  padding: 16px;
  padding-bottom: 80px;
}

.page.active {
  display: block;
}

h2 {
  margin-top: 0;
}

input, button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  margin-bottom: 12px;
  font-size: 16px;
}

input {
  background: var(--card);
  color: var(--text);
}

button {
  background: var(--accent);
  color: white;
  font-weight: 600;
}

/* –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 10px;
}

.price {
  color: var(--hint);
  margin-top: 4px;
}

.delete {
  color: red;
  float: right;
  cursor: pointer;
}

/* bottom bar */
.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  display: flex;
  border-top: 1px solid #ddd;
}

.tabbar button {
  flex: 1;
  background: none;
  border: none;
  padding: 14px;
  font-size: 15px;
  color: var(--hint);
}

.tabbar button.active {
  color: var(--accent);
  font-weight: 600;
}
</style>
</head>

<body>

<!-- –ü–†–û–§–ò–õ–¨ -->
<div id="profile" class="page active">
  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
  <input id="name" placeholder="–§–ò–û">
  <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
  <input id="username" disabled>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- –ú–û–ò –û–ë–™–Ø–í–õ–ï–ù–ò–Ø -->
<div id="myAds" class="page">
  <h2>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
  <div id="adsList"></div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <button id="btnProfile" class="active">–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button id="btnAds">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const USER = tg.initDataUnsafe.user;
const USER_ID = USER.id;
const USERNAME = USER.username || "";

// üî¥ –í–°–¢–ê–í–¨ –°–Æ–î–ê URL
const API_URL = "https://script.google.com/macros/s/AKfycbwKJgT9fCS4i3P8dSD5kZZqtXVC25v5GFIT6a4BJRGMu1BE6Oi8XEPnRf8qk_mqfzylZQ/exec";

/* --- TAB LOGIC --- */
btnProfile.onclick = () => switchPage("profile", btnProfile);
btnAds.onclick = () => {
  switchPage("myAds", btnAds);
  loadMyAds();
};

function switchPage(pageId, btn) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".tabbar button").forEach(b => b.classList.remove("active"));
  document.getElementById(pageId).classList.add("active");
  btn.classList.add("active");
}

/* --- LOAD PROFILE --- */
fetch(`${API_URL}?action=getUser&userId=${USER_ID}&username=${USERNAME}`)
  .then(r => r.json())
  .then(data => {
    name.value = data.name || "";
    phone.value = data.phone || "";
    username.value = "@" + (data.username || "");
  });

function saveProfile() {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "saveUser",
      userId: USER_ID,
      name: name.value,
      phone: phone.value,
      username: USERNAME
    })
  }).then(() => tg.showAlert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω"));
}

/* --- –ú–û–ò –û–ë–™–Ø–í–õ–ï–ù–ò–Ø --- */
function loadMyAds() {
  fetch(`${API_URL}?action=getAds`)
    .then(r => r.json())
    .then(data => {
      adsList.innerHTML = "";
      data
        .filter(ad => ad.userId == USER_ID)
        .forEach(ad => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <strong>${ad.title}</strong>
            <span class="delete" onclick="deleteAd(${ad.id})">–£–¥–∞–ª–∏—Ç—å</span>
            <div class="price">${ad.price} ‚ÇΩ ¬∑ ${ad.district}</div>
          `;
          adsList.appendChild(div);
        });
    });
}

function deleteAd(id) {
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "deleteAd",
      id: id,
      userId: USER_ID
    })
  }).then(loadMyAds);
}
</script>

</body>
</html>