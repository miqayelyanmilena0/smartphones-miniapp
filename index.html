<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartMarket</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: var(--tg-theme-bg-color, #f2f2f7);
  --card: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #000000);
  --hint: var(--tg-theme-hint-color, #8e8e93);
  --accent: var(--tg-theme-button-color, #007aff);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Roboto;
  background: var(--bg);
  color: var(--text);
}

.page {
  display: none;
  padding: 16px;
  padding-bottom: 110px;
}
.page.active { display: block; }

input, textarea {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  margin-bottom: 12px;
  font-size: 16px;
  background: var(--card);
  color: var(--text);
}

textarea { resize: none; }

.card {
  background: var(--card);
  border-radius: 18px;
  padding: 14px;
  margin-bottom: 14px;
}

.card img {
  width: 100%;
  border-radius: 14px;
  margin-bottom: 10px;
}

.price {
  color: var(--hint);
  margin-top: 6px;
}

.btn {
  width: 100%;
  padding: 14px;
  border-radius: 16px;
  border: none;
  font-size: 16px;
  background: var(--accent);
  color: white;
}

.small-btn {
  margin-top: 10px;
  background: none;
  color: var(--accent);
  border: 1px solid var(--accent);
}

.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  display: flex;
  border-top: 1px solid #ddd;
}

.tabbar button {
  flex: 1;
  padding: 14px;
  background: none;
  border: none;
  font-size: 15px;
  color: var(--hint);
}

.tabbar button.active {
  color: var(--accent);
  font-weight: 600;
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
}
.modal.active { display: flex; }

.modal-content {
  margin: auto;
  background: var(--bg);
  padding: 20px;
  width: 90%;
  border-radius: 20px;
}
</style>
</head>

<body>

<!-- ALL ADS -->
<div id="allAds" class="page active">
  <h2>Объявления</h2>
  <input id="search" placeholder="Поиск">
  <button class="btn small-btn" id="addBtn">+ Разместить</button>
  <div id="allAdsList"></div>
</div>

<!-- MY ADS -->
<div id="myAds" class="page">
  <h2>Мои объявления</h2>
  <div id="myAdsList"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
  <h2>Профиль</h2>
  <input id="name" placeholder="ФИО">
  <input id="phone" placeholder="Телефон">
  <button class="btn">Сохранить</button>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Новое объявление</h3>
    <input id="title" placeholder="Модель">
    <input id="price" placeholder="Цена ₽">
    <input id="district" placeholder="Район">
    <textarea id="desc" placeholder="Описание"></textarea>
    <input type="file" id="photo">
    <button class="btn" id="publishBtn">Опубликовать</button>
  </div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <button id="tabAll" class="active">Объявления</button>
  <button id="tabMy">Мои</button>
  <button id="tabProfile">Профиль</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const USER = tg.initDataUnsafe.user;
const USER_ID = USER?.id || 0;
const USERNAME = USER?.username || "";

const API_URL = "https://script.google.com/macros/s/AKfycbyN56_mRAB9xp4gk6UAgkmMNQ2FuoxaeAo9WVfUnfB-OcsLxH0d0fK6XKKeRodr-SuF-Q/exec";

/* NAV */
tabAll.onclick = () => show(allAds, tabAll);
tabMy.onclick = () => { show(myAds, tabMy); loadAllAds(); };
tabProfile.onclick = () => show(profile, tabProfile);

function show(page, btn){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tabbar button').forEach(b => b.classList.remove('active'));
  page.classList.add('active');
  btn.classList.add('active');
}

/* MODAL */
addBtn.onclick = () => modal.classList.add("active");
modal.onclick = e => { if(e.target === modal) modal.classList.remove("active"); };

/* ADD AD */
publishBtn.onclick = () => {
  const file = photo.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(",")[1];

    fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        action: "addAd",
        userId: USER_ID,
        username: USERNAME,
        title: title.value,
        price: price.value,
        district: district.value,
        desc: desc.value,
        imageBase64: base64,
        imageName: file.name
      })
    }).then(() => {
      modal.classList.remove("active");
      loadAllAds();
    });
  };
  reader.readAsDataURL(file);
};

/* LOAD ADS */
function loadAllAds(){
  fetch(API_URL + "?action=getAds")
    .then(r => r.json())
    .then(data => {
      allAdsList.innerHTML = "";
      data.forEach(ad => {
        const card = document.createElement("div");
        card.className = "card";

        if (ad.imageUrl) {
          const img = document.createElement("img");
          img.src = ad.imageUrl;
          card.appendChild(img);
        }

        card.innerHTML += `
          <strong>${ad.title}</strong>
          <div>${ad.desc || ""}</div>
          <div class="price">${ad.price} ₽ · ${ad.district}</div>
        `;

        if (ad.username) {
          const btn = document.createElement("button");
          btn.className = "btn small-btn";
          btn.textContent = "Написать продавцу";
          btn.onclick = () => tg.openTelegramLink(`https://t.me/${ad.username}`);
          card.appendChild(btn);
        }

        allAdsList.appendChild(card);
      });
    });
}

search.oninput = loadAllAds;
loadAllAds();
</script>

</body>
</html>